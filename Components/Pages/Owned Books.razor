@page "/owned"
@using Capstone_Project_v0._1.Data
@using Capstone_Project_v0._1.Models
@inject Capstone_Project_v0._1.Data.LibraryRepository Repo
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject Capstone_Project_v0._1.Services.UserSessionState Session


<PageTitle>Owned Books</PageTitle>

<!-- Owned Books page layout -->
<div class="container mt-4">
    <h2>Owned Books</h2>
    <p class="text-muted">Books you currently own.</p>

    <!-- Toolbar buttons for managing the list -->
    <div class="mb-3">
        <!-- Reloads the book list from the database -->
        <button class="btn btn-secondary me-2" @onclick="Refresh">Refresh</button>
        <!-- Deletes all data from both Books and UserBooks tables -->
        <button class="btn btn-outline-danger" @onclick="ClearAll">Clear All</button>
        <!-- Displays feedback or status messages -->
        <span class="ms-2 text-muted">@message</span>
    </div>

    <!-- If there are no books, show an info alert -->
    @if (owned.Count == 0)
    {
        <div class="alert alert-info">You have no owned books yet. Add some from the Home page!</div>
    }

    else
    {
        <!-- Otherwise, render a table of owned books -->
        <table class="table table-striped table-hover">
            <thead class="table-light">
                <tr>
                    <th>Title</th>
                    <th>Author</th>
                    <th>ISBN</th>
                    <th>Pages</th>
                    <th>Year</th>
                    <th>Status</th>
                    <th style="width: 120px;">Actions</th>
                </tr>
            </thead>
            <tbody>
            <!-- Loop through each owned book record -->
                @foreach (var ub in owned)
                {
                    <tr>
                    <!-- Book details come from the linked Book object -->
                        <td>@ub.Book?.Title</td>
                        <td>@ub.Book?.AuthorName</td>
                        <td>@ub.Book?.ISBN</td>
                        <td>@ub.Book?.PageCount</td>
                        <td>@ub.Book?.PublishYear</td>
                        <td>@ub.Status</td>
                        <td>
                        <!-- Remove button calls Remove() for this specific record -->
                            <button class="btn btn-sm btn-outline-danger"
                                    @onclick="() => Remove(ub)">
                                Remove
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }

    <!-- Display the path to the SQLite file (useful for debugging/demo) -->
    <div class="mt-3 small text-muted">
        Database: @dbPath
    </div>
</div>

@code {
    private List<UserBook> owned = new();
    private string dbPath = Path.Combine(FileSystem.AppDataDirectory, "bookstore.db");
    private string message = "";

    protected override async Task OnInitializedAsync()
    {
        if (!Session.IsAuthenticated)
        {
            Nav.NavigateTo("/login", true);
            return;
        }

        try
        {
            await Refresh();
        }
        catch (Exception ex)
        {
            message = $"Error loading owned books: {ex.Message}";
        }
    }

    private async Task Refresh()
    {
        owned = await Repo.GetOwnedAsync();
        message = $"Loaded {owned.Count} book(s).";
        StateHasChanged();
    }

    private async Task ClearAll()
    {
        bool ok = await JS.InvokeAsync<bool>("confirm",
            "Are you sure you want to clear ALL of YOUR owned books? This action cannot be undone.");
        if (!ok) return;

        // Clear only this user's Owned entries, and delete orphaned Book records
        await Repo.ClearStatusForCurrentUserAsync(Status.Owned, deleteOrphanBooks: true);

        owned.Clear();
        message = "Your owned books have been cleared.";
    }

    private async Task Remove(UserBook ub)
    {
        bool ok = await JS.InvokeAsync<bool>("confirm",
            $"Remove \"{ub.Book?.Title}\" from Owned? This may also delete the book if nothing else references it.");
        if (!ok) return;

        await Repo.RemoveOwnedAsync(ub.OwnedBookID, deleteBookIfOrphan: true);
        await Refresh();
    }
}