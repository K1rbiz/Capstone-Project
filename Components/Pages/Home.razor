@page "/"
@using Capstone_Project_v0._1.Data
@using Capstone_Project_v0._1.Models
@inject LibraryRepository Repo

<PageTitle>Home</PageTitle>

<!-- Main page layout -->
<div class="container mt-4">
    <h2 class="mb-1">Capstone Library</h2>
    <p class="text-muted">Quickly add books and manage your local library.</p>

    <!-- Card containing the book entry form -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Add a Book</h5>

            <!-- The form fields are grouped in a responsive row layout -->
            <div class="row g-3">
                <!-- Title input -->
                <div class="col-md-6">
                    <label class="form-label">Title</label>
                    <input class="form-control" @bind="title" placeholder="e.g., The Lord of the Rings" />
                </div>
                <!-- Author input -->
                <div class="col-md-6">
                    <label class="form-label">Author</label>
                    <input class="form-control" @bind="author" placeholder="e.g., J. R. R. Tolkien" />
                </div>
                <!-- ISBN input -->
                <div class="col-md-4">
                    <label class="form-label">ISBN</label>
                    <input class="form-control" @bind="isbn" placeholder="optional" />
                </div>
                <!-- Page count input -->
                <div class="col-md-4">
                    <label class="form-label">Page Count</label>
                    <input type="number" class="form-control" @bind="pageCount" min="1" />
                </div>
                <!-- Publish year input -->
                <div class="col-md-4">
                    <label class="form-label">Publish Year</label>
                    <input type="number" class="form-control" @bind="publishYear" min="0" />
                </div>
                <!-- Dropdown to select where the book should be added -->
                <div class="col-md-4">
                    <label class="form-label">Add To</label>
                    <select class="form-select" @bind="selectedStatus">
                        <option value="@Status.Owned">Owned</option>
                        <option value="@Status.WishList">Wishlist</option>
                    </select>
                </div>
            </div>
            <!-- Submit section -->
            <div class="mt-3">
                <button class="btn btn-primary me-2" @onclick="AddBook" disabled="@isBusy">Add Book</button>
                <span class="text-muted">@message</span>
            </div>
        </div>
    </div>
</div>

@code {
    // form fields
    private string title = "";
    private string author = "";
    private string isbn = "";
    private int pageCount = 0;
    private int publishYear = @DateTime.Now.Year;
    private Status selectedStatus = Status.Owned;

    // Tracks if the form is processing a save action
    private bool isBusy = false;
    // Message displayed under the button ("Book added", "Error", etc.)
    private string message = "";
    // Path to the local SQLite database file
    private string dbPath = Path.Combine(FileSystem.AppDataDirectory, "bookstore.db");

    protected override void OnInitialized()
    {
        // not used yet
    }

    // Method triggered when the "Add Book" button is clicked
    private async Task AddBook()
    {
        // Simple validation: ensure Title and Author are not empty
        if (string.IsNullOrWhiteSpace(title) || string.IsNullOrWhiteSpace(author))
        {
            message = "Please provide at least Title and Author.";
            return;
        }
        // Mark the form as busy (disables button) and show a saving message
        isBusy = true; message = "Saving...";
        try
        {
            // Call repository to add a new Book + link to UserBook table
            await Repo.AddBookWithStatusAsync(
                title: title.Trim(),
                authorName: author.Trim(),
                isbn: string.IsNullOrWhiteSpace(isbn) ? null : isbn.Trim(),
                pageCount: Math.Max(pageCount, 0),
                publishYear: publishYear,
                status: selectedStatus
            );

            // clear form
            title = ""; author = ""; isbn = ""; pageCount = 0; publishYear = DateTime.Now.Year;
            selectedStatus = Status.Owned;
            // Show success message
            message = "Book added.";
        }
        catch (Exception ex)
        {
            // If something fails (e.g., DB issue), show the error message
            message = $"Error: {ex.Message}";
        }
        finally
        {
            // Allow the button to be clicked again
            isBusy = false;
        }
    }

    [Inject] NavigationManager Navigation { get; set; } = default!;
}
